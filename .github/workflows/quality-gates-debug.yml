name: Quality Gates - Debug

on:
  workflow_dispatch:

jobs:
  debug-quality-gates:
    name: Debug Quality Gates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        echo "ğŸ” Installing dependencies..."
        npm ci
        echo "âœ… Dependencies installed"
        
    - name: Debug - Check directory structure
      run: |
        echo "ğŸ” DEBUG: Current directory: $(pwd)"
        echo "ğŸ” DEBUG: Directory contents:"
        ls -la
        echo "ğŸ” DEBUG: Services directory:"
        ls -la services/ || echo "Services directory not found"
        echo "ğŸ” DEBUG: AI-disabled directory:"
        ls -la services/ai-disabled/ || echo "AI-disabled directory not found"
        
    - name: Debug - Check specific files
      run: |
        echo "ğŸ” DEBUG: Checking for Therapist v1.2 prompt..."
        if [ -f "services/ai-disabled/prompts/therapist/v1.2.md" ]; then
          echo "âœ… Therapist v1.2 prompt exists"
        else
          echo "âŒ Therapist v1.2 prompt missing"
          echo "ğŸ” DEBUG: AI-disabled prompts directory:"
          ls -la services/ai-disabled/prompts/ || echo "Prompts directory not found"
        fi
        
        echo "ğŸ” DEBUG: Checking for JSON schema..."
        if [ -f "services/ai-disabled/src/schemas/therapist.v1_2.schema.json" ]; then
          echo "âœ… JSON schema exists"
        else
          echo "âŒ JSON schema missing"
          echo "ğŸ” DEBUG: AI-disabled schemas directory:"
          ls -la services/ai-disabled/src/schemas/ || echo "Schemas directory not found"
        fi
        
        echo "ğŸ” DEBUG: Checking for validator..."
        if [ -f "services/ai-disabled/src/validation/therapistValidator.ts" ]; then
          echo "âœ… Validator exists"
        else
          echo "âŒ Validator missing"
          echo "ğŸ” DEBUG: AI-disabled validation directory:"
          ls -la services/ai-disabled/src/validation/ || echo "Validation directory not found"
        fi
        
    - name: Debug - Test npm commands
      run: |
        echo "ğŸ” DEBUG: Testing npm run type-check..."
        npm run type-check || echo "âŒ Type check failed"
        
        echo "ğŸ” DEBUG: Testing npm run test:log-scan..."
        npm run test:log-scan || echo "âŒ Log scan failed"
        
        echo "ğŸ” DEBUG: Testing npm run test..."
        npm run test || echo "âŒ Tests failed"
        
        echo "ğŸ” DEBUG: Testing npm run build..."
        npm run build -- --filter=!@sync/website || echo "âŒ Build failed"
        
    - name: Debug - Final status
      run: |
        echo "ğŸ¯ DEBUG: All debug steps completed"
        echo "âœ… Check the output above to identify the failure point"
