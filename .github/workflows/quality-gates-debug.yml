name: Quality Gates - Debug

on:
  workflow_dispatch:

jobs:
  debug-quality-gates:
    name: Debug Quality Gates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        echo "🔍 Installing dependencies..."
        npm ci
        echo "✅ Dependencies installed"
        
    - name: Debug - Check directory structure
      run: |
        echo "🔍 DEBUG: Current directory: $(pwd)"
        echo "🔍 DEBUG: Directory contents:"
        ls -la
        echo "🔍 DEBUG: Services directory:"
        ls -la services/ || echo "Services directory not found"
        echo "🔍 DEBUG: AI-disabled directory:"
        ls -la services/ai-disabled/ || echo "AI-disabled directory not found"
        
    - name: Debug - Check specific files
      run: |
        echo "🔍 DEBUG: Checking for Therapist v1.2 prompt..."
        if [ -f "services/ai-disabled/prompts/therapist/v1.2.md" ]; then
          echo "✅ Therapist v1.2 prompt exists"
        else
          echo "❌ Therapist v1.2 prompt missing"
          echo "🔍 DEBUG: AI-disabled prompts directory:"
          ls -la services/ai-disabled/prompts/ || echo "Prompts directory not found"
        fi
        
        echo "🔍 DEBUG: Checking for JSON schema..."
        if [ -f "services/ai-disabled/src/schemas/therapist.v1_2.schema.json" ]; then
          echo "✅ JSON schema exists"
        else
          echo "❌ JSON schema missing"
          echo "🔍 DEBUG: AI-disabled schemas directory:"
          ls -la services/ai-disabled/src/schemas/ || echo "Schemas directory not found"
        fi
        
        echo "🔍 DEBUG: Checking for validator..."
        if [ -f "services/ai-disabled/src/validation/therapistValidator.ts" ]; then
          echo "✅ Validator exists"
        else
          echo "❌ Validator missing"
          echo "🔍 DEBUG: AI-disabled validation directory:"
          ls -la services/ai-disabled/src/validation/ || echo "Validation directory not found"
        fi
        
    - name: Debug - Test npm commands
      run: |
        echo "🔍 DEBUG: Testing npm run type-check..."
        npm run type-check || echo "❌ Type check failed"
        
        echo "🔍 DEBUG: Testing npm run test:log-scan..."
        npm run test:log-scan || echo "❌ Log scan failed"
        
        echo "🔍 DEBUG: Testing npm run test..."
        npm run test || echo "❌ Tests failed"
        
        echo "🔍 DEBUG: Testing npm run build..."
        npm run build -- --filter=!@sync/website || echo "❌ Build failed"
        
    - name: Debug - Final status
      run: |
        echo "🎯 DEBUG: All debug steps completed"
        echo "✅ Check the output above to identify the failure point"
