name: Quality Gates - Working Version

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  quality-gates-working:
    name: Working Quality Gates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Verify essential files exist
      run: |
        echo "ğŸ” Verifying essential files..."
        # Check if the ai-disabled directory exists
        if [ -d "services/ai-disabled" ]; then
          echo "âœ… services/ai-disabled directory exists"
        else
          echo "âŒ services/ai-disabled directory missing"
          exit 1
        fi
        
        # Check if the required files exist
        if [ -f "services/ai-disabled/prompts/therapist/v1.2.md" ]; then
          echo "âœ… Therapist v1.2 prompt exists"
        else
          echo "âŒ Therapist v1.2 prompt missing"
          exit 1
        fi
        
        if [ -f "services/ai-disabled/src/schemas/therapist.v1_2.schema.json" ]; then
          echo "âœ… JSON schema exists"
        else
          echo "âŒ JSON schema missing"
          exit 1
        fi
        
        if [ -f "services/ai-disabled/src/validation/therapistValidator.ts" ]; then
          echo "âœ… Validator exists"
        else
          echo "âŒ Validator missing"
          exit 1
        fi
        
        echo "âœ… All essential files verified"
        
    - name: Run basic checks
      run: |
        echo "ğŸ” Running basic checks..."
        
        # TypeScript compilation
        echo "ğŸ” TypeScript compilation..."
        npm run type-check
        echo "âœ… TypeScript compilation passed"
        
        # Tests
        echo "ğŸ” Running tests..."
        npm run test
        echo "âœ… Tests passed"
        
        # Log security scan
        echo "ğŸ” Running log security scan..."
        npm run test:log-scan
        echo "âœ… Log security scan passed"
        
        # Build (excluding website)
        echo "ğŸ” Building packages..."
        npm run build -- --filter=!@sync/website
        echo "âœ… Build passed"
        
    - name: Success
      run: |
        echo "ğŸ‰ ALL QUALITY GATES PASSED!"
        echo "âœ… Repository is ready for development"
